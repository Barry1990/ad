<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gxq.mapper.OrgSettingMapper">

    <select id="selectById" parameterType="java.lang.Long" >
        SELECT * FROM t_org_setting WHERE org_id = #{id}
    </select>

    <select id="selectOrgAccountSetting" parameterType="OrgSettingSearchModel">
        SELECT
            t.id AS org_id ,
            t.name ,
            t.wx_account ,
            t.ali_account
        FROM
            (
                SELECT
                    o.id ,
                    o.type ,
                    o.name ,
                    os.wx_account ,
                    os.ali_account,
                    CASE WHEN os.wx_account IS NOT NULL AND os.ali_account IS NOT NULL THEN 1 ELSE 0
                            END AS is_setting
                FROM
                    organization o
                LEFT JOIN t_org_setting os ON o.id = os.org_id
            ) t
        WHERE
            FIND_IN_SET(t.id , getOrgChildren(#{orgId}))
            AND t.type = 1
            <if test="isSetting!=null">   AND t.is_setting = #{isSetting} </if>

    </select>

    <insert id="insert" parameterType="ShopModel">
        INSERT INTO t_org_setting(
            org_id ,
            wx_account ,
            ali_account ,
            period_type ,
            period_time ,
            create_one ,
            create_time
        )
        VALUES (
		    #{orgId},
		    #{wxAccount},
		    #{aliAccount},
		    #{periodType},
		    #{periodTime},
		    #{createOne},
		    SYSDATE()
		)
    </insert>

    <update id="update" parameterType="ShopModel">
        UPDATE t_org_setting
        SET
        <if test="wxAccount!=null">  wx_account = #{wxAccount},   </if>
        <if test="aliAccount!=null"> ali_account = #{aliAccount}, </if>
        <if test="periodType!=null"> period_type = #{periodType}, </if>
        <if test="periodTime!=null"> period_time = #{periodTime}, </if>
        <if test="updateOne!=null">  update_one = #{updateOne},   </if>
        update_time = SYSDATE()
        WHERE org_id = #{orgId}
    </update>

    <insert id="insertHistory" parameterType="OrgSettingModel">
        INSERT INTO t_org_setting_his(
            org_id ,
            wx_account ,
            ali_account ,
            period_type ,
            period_time ,
            is_history ,
            create_one ,
            create_time
        )
        VALUES (
		    #{orgId},
		    #{wxAccount},
		    #{aliAccount},
		    #{periodType},
		    #{periodTime},
		    0,
		    #{createOne},
		    SYSDATE()
		)
    </insert>

    <update id="updateHistory" parameterType="OrgSettingModel">
        UPDATE t_org_setting_his
        SET
        <if test="wxAccount!=null">  wx_account = #{wxAccount},   </if>
        <if test="aliAccount!=null"> ali_account = #{aliAccount}, </if>
        <if test="periodType!=null"> period_type = #{periodType}, </if>
        <if test="periodTime!=null"> period_time = #{periodTime}, </if>
        <if test="updateOne!=null">  update_one = #{updateOne},   </if>
        update_time = SYSDATE(),
        is_history = 1
        WHERE org_id = #{orgId}
    </update>


    <resultMap type="com.gxq.model.OrgSettingModel" id="orgSettingMap">
        <id property="orgId" column="org_id"/>
        <result property="name" column="name"/>
        <result property="wxAccount" column="wx_account"/>
        <result property="aliAccount" column="ali_account"/>
    </resultMap>

</mapper>